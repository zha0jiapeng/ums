pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'ums-server'
        VERSION = '2.0'
        DOCKER_IMAGE = 'ums-server:2.0'
        LOCAL_CODE_PATH = '/opt/ums-server-code'
    }
    
    stages {
        stage('Prepare Local Code') {
            steps {
                script {
                    // æ£€æŸ¥æœ¬åœ°ä»£ç ç›®å½•
                    if (!fileExists(LOCAL_CODE_PATH)) {
                        error "Local code directory does not exist: ${LOCAL_CODE_PATH}"
                    }
                    
                    // å¤åˆ¶æœ¬åœ°ä»£ç åˆ°å·¥ä½œç©ºé—´
                    sh """
                        echo "Copying local code to workspace..."
                        cp -r ${LOCAL_CODE_PATH}/* .
                        echo "Files in workspace:"
                        ls -la
                    """
                    
                    echo "Local code preparation completed"
                }
            }
        }
        
        stage('Maven Build') {
            steps {
                script {
                    // æ£€æŸ¥Mavenæ˜¯å¦å¯ç”¨
                    sh 'mvn --version'
                    
                    // æ‰§è¡ŒMavenæ„å»º
                    sh 'mvn clean package -DskipTests'
                    
                    // å½’æ¡£æ„å»ºäº§ç‰©
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                    
                    echo "Maven build completed"
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                script {
                    // é‡å‘½åJARæ–‡ä»¶
                    sh 'cp target/ums-0.0.1-SNAPSHOT.jar ums-0.0.1-SNAPSHOT.jar'
                    
                    // æ„å»ºDockeré•œåƒ
                    docker.build(DOCKER_IMAGE)
                    
                    echo "Docker image built successfully"
                }
            }
        }
        
        stage('Docker Compose Deploy') {
            steps {
                script {
                    // éƒ¨ç½²åº”ç”¨
                    sh """
                        echo "Starting deployment..."
                        
                        # åœæ­¢ç°æœ‰æœåŠ¡
                        docker-compose down || true
                        
                        # å¯åŠ¨æ‰€æœ‰æœåŠ¡
                        docker-compose up -d
                        
                        # ç­‰å¾…æœåŠ¡å¯åŠ¨
                        echo "Waiting for services to start..."
                        sleep 30
                        
                        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                        echo "Service status:"
                        docker-compose ps
                    """
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    // ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
                    sh 'sleep 60'
                    
                    // æ‰§è¡Œå¥åº·æ£€æŸ¥
                    sh """
                        echo "Performing health checks..."
                        
                        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                        echo "Container status:"
                        docker ps | grep ums-server || echo "UMS server container not found"
                        
                        # æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
                        echo "Application health check:"
                        curl -f http://localhost:38080/actuator/health || echo "Health check failed"
                        
                        # æ£€æŸ¥æ•°æ®åº“è¿æ¥
                        echo "Database connection check:"
                        docker exec ums-mysql mysql -uroot -pfbmMTEz7TuHx -e "SELECT 1;" || echo "Database connection failed"
                        
                        # æ£€æŸ¥Redisè¿æ¥
                        echo "Redis connection check:"
                        docker exec ums-redis redis-cli ping || echo "Redis connection failed"
                    """
                }
            }
        }
    }
    
    post {
        always {
            // æ¸…ç†å·¥ä½œç©ºé—´
            cleanWs()
            
            // æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
            script {
                sh """
                    echo "=== Final Status ==="
                    docker-compose ps
                    echo "=== Service URLs ==="
                    echo "Application: http://localhost:38080"
                    echo "MySQL: localhost:33306"
                    echo "Redis: localhost:36379"
                """
            }
        }
        success {
            echo "ğŸ‰ Deployment successful!"
            echo "Application is running at http://localhost:38080"
            echo "MySQL is running at localhost:33306"
            echo "Redis is running at localhost:36379"
        }
        failure {
            echo "âŒ Deployment failed!"
            script {
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                sh """
                    echo "=== Error Diagnosis ==="
                    echo "Container status:"
                    docker-compose ps
                    echo "Application logs:"
                    docker-compose logs ums-app || echo "Cannot get application logs"
                    echo "MySQL logs:"
                    docker-compose logs mysql || echo "Cannot get MySQL logs"
                    echo "Redis logs:"
                    docker-compose logs redis || echo "Cannot get Redis logs"
                """
            }
        }
        cleanup {
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            sh 'rm -f ums-0.0.1-SNAPSHOT.jar || true'
        }
    }
} 