pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'ums-server'
        VERSION = '2.0'
        DOCKER_IMAGE = 'ums-server:2.0'
        DEPLOY_PATH = '/opt/ums-server'
        // æœ¬åœ°ä»£ç è·¯å¾„ï¼Œé¿å…ç½‘ç»œè¿æ¥é—®é¢˜
        LOCAL_CODE_PATH = '/opt/ums-server-code'
    }
    
    stages {
        stage('å‡†å¤‡æœ¬åœ°ä»£ç ') {
            steps {
                script {
                    // æ£€æŸ¥æœ¬åœ°ä»£ç ç›®å½•æ˜¯å¦å­˜åœ¨
                    if (!fileExists(LOCAL_CODE_PATH)) {
                        error "æœ¬åœ°ä»£ç ç›®å½•ä¸å­˜åœ¨: ${LOCAL_CODE_PATH}"
                    }
                    
                    // å¤åˆ¶æœ¬åœ°ä»£ç åˆ°å·¥ä½œç©ºé—´
                    sh """
                        echo "å¤åˆ¶æœ¬åœ°ä»£ç åˆ°å·¥ä½œç©ºé—´..."
                        cp -r ${LOCAL_CODE_PATH}/* .
                        ls -la
                    """
                    
                    echo "æœ¬åœ°ä»£ç å‡†å¤‡å®Œæˆ"
                }
            }
        }
        
        stage('Mavenæ„å»º') {
            steps {
                script {
                    // æ£€æŸ¥Mavenæ˜¯å¦å¯ç”¨
                    sh 'mvn --version'
                    
                    // æ‰§è¡ŒMavenæ„å»º
                    sh 'mvn clean package -DskipTests'
                    
                    // å½’æ¡£æ„å»ºäº§ç‰©
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                    
                    echo "Mavenæ„å»ºå®Œæˆ"
                }
            }
        }
        
        stage('Dockeræ„å»º') {
            steps {
                script {
                    // é‡å‘½åJARæ–‡ä»¶ä»¥åŒ¹é…Dockerfileä¸­çš„åç§°
                    sh 'cp target/ums-0.0.1-SNAPSHOT.jar ums-0.0.1-SNAPSHOT.jar'
                    
                    // æ„å»ºDockeré•œåƒ
                    docker.build(DOCKER_IMAGE)
                    
                    echo "Dockeré•œåƒæ„å»ºå®Œæˆ"
                }
            }
        }
        
        stage('Docker Composeéƒ¨ç½²') {
            steps {
                script {
                    // ä½¿ç”¨docker-composeè¿›è¡Œéƒ¨ç½²
                    sh """
                        echo "å¼€å§‹éƒ¨ç½²..."
                        
                        # åœæ­¢ç°æœ‰æœåŠ¡
                        docker-compose down || true
                        
                        # æ¸…ç†æ—§é•œåƒï¼ˆå¯é€‰ï¼‰
                        docker image prune -f || true
                        
                        # å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬MySQLã€Rediså’Œåº”ç”¨ï¼‰
                        docker-compose up -d
                        
                        # ç­‰å¾…æœåŠ¡å¯åŠ¨
                        echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
                        sleep 30
                        
                        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                        docker-compose ps
                    """
                }
            }
        }
        
        stage('å¥åº·æ£€æŸ¥') {
            steps {
                script {
                    // ç­‰å¾…åº”ç”¨å¯åŠ¨
                    sh 'sleep 60'
                    
                    // æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
                    sh """
                        echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
                        
                        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                        echo "å®¹å™¨çŠ¶æ€ï¼š"
                        docker ps | grep ums-server || echo "æœªæ‰¾åˆ°ums-serverå®¹å™¨"
                        
                        # æ£€æŸ¥åº”ç”¨ç«¯å£
                        echo "åº”ç”¨å¥åº·æ£€æŸ¥ï¼š"
                        curl -f http://localhost:38080/actuator/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"
                        
                        # æ£€æŸ¥æ•°æ®åº“è¿æ¥
                        echo "æ•°æ®åº“è¿æ¥æ£€æŸ¥ï¼š"
                        docker exec ums-mysql mysql -uroot -pfbmMTEz7TuHx -e "SELECT 1;" || echo "æ•°æ®åº“è¿æ¥å¤±è´¥"
                        
                        # æ£€æŸ¥Redisè¿æ¥
                        echo "Redisè¿æ¥æ£€æŸ¥ï¼š"
                        docker exec ums-redis redis-cli ping || echo "Redisè¿æ¥å¤±è´¥"
                    """
                }
            }
        }
        
        stage('éƒ¨ç½²éªŒè¯') {
            steps {
                script {
                    // éªŒè¯éƒ¨ç½²ç»“æœ
                    sh """
                        echo "éªŒè¯éƒ¨ç½²ç»“æœ..."
                        
                        # æ£€æŸ¥æœåŠ¡ç«¯å£
                        netstat -tlnp | grep 38080 || echo "åº”ç”¨ç«¯å£æœªç›‘å¬"
                        netstat -tlnp | grep 33306 || echo "MySQLç«¯å£æœªç›‘å¬"
                        netstat -tlnp | grep 36379 || echo "Redisç«¯å£æœªç›‘å¬"
                        
                        # æ£€æŸ¥åº”ç”¨æ—¥å¿—
                        echo "åº”ç”¨æ—¥å¿—ï¼ˆæœ€è¿‘10è¡Œï¼‰ï¼š"
                        docker-compose logs --tail=10 ums-app || echo "æ— æ³•è·å–åº”ç”¨æ—¥å¿—"
                    """
                }
            }
        }
    }
    
    post {
        always {
            // æ¸…ç†å·¥ä½œç©ºé—´
            cleanWs()
            
            // æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
            script {
                sh """
                    echo "=== éƒ¨ç½²çŠ¶æ€ ==="
                    docker-compose ps
                    echo "=== æœåŠ¡åœ°å€ ==="
                    echo "åº”ç”¨åœ°å€: http://localhost:38080"
                    echo "MySQLåœ°å€: localhost:33306"
                    echo "Redisåœ°å€: localhost:36379"
                """
            }
        }
        success {
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "åº”ç”¨è¿è¡Œåœ¨ http://localhost:38080"
            echo "MySQLè¿è¡Œåœ¨ localhost:33306"
            echo "Redisè¿è¡Œåœ¨ localhost:36379"
        }
        failure {
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            script {
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                sh """
                    echo "=== é”™è¯¯è¯Šæ–­ ==="
                    echo "å®¹å™¨çŠ¶æ€ï¼š"
                    docker-compose ps
                    echo "åº”ç”¨æ—¥å¿—ï¼š"
                    docker-compose logs ums-app || echo "æ— æ³•è·å–åº”ç”¨æ—¥å¿—"
                    echo "MySQLæ—¥å¿—ï¼š"
                    docker-compose logs mysql || echo "æ— æ³•è·å–MySQLæ—¥å¿—"
                    echo "Redisæ—¥å¿—ï¼š"
                    docker-compose logs redis || echo "æ— æ³•è·å–Redisæ—¥å¿—"
                """
            }
        }
        cleanup {
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            sh 'rm -f ums-0.0.1-SNAPSHOT.jar || true'
        }
    }
} 