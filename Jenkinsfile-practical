pipeline {
    agent any
    
    environment {
        // é¡¹ç›®é…ç½®
        PROJECT_NAME = 'ums-server'
        VERSION = '2.0'
        DOCKER_IMAGE = 'ums-server:2.0'
        
        // æ„å»ºäº§ç‰©
        JAR_FILE = 'target/ums-0.0.1-SNAPSHOT.jar'
        
        // éƒ¨ç½²é…ç½® - è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
        DEPLOY_HOST = '192.168.1.100'  // ä¿®æ”¹ä¸ºæ‚¨çš„æœåŠ¡å™¨IP
        DEPLOY_USER = 'deploy'
        DEPLOY_PATH = '/opt/ums-server'
    }
    
    options {
        // æ„å»ºå†å²ä¿ç•™
        buildDiscarder(logRotator(numToKeepStr: '5'))
        // è¶…æ—¶è®¾ç½®
        timeout(time: 20, unit: 'MINUTES')
    }
    
    stages {
        stage('ä»£ç æ£€å‡º') {
            steps {
                checkout scm
                echo "âœ… ä»£ç æ£€å‡ºå®Œæˆï¼Œåˆ†æ”¯: ${env.BRANCH_NAME}"
            }
        }
        
        stage('Mavenæ„å»º') {
            steps {
                script {
                    echo "ğŸ”¨ å¼€å§‹Mavenæ„å»º..."
                    
                    // æ¸…ç†å¹¶ç¼–è¯‘
                    sh 'mvn clean compile -DskipTests'
                    
                    // æ‰“åŒ…
                    sh 'mvn package -DskipTests'
                    
                    // éªŒè¯æ„å»ºäº§ç‰©
                    sh "ls -la ${JAR_FILE}"
                    
                    echo "âœ… Mavenæ„å»ºå®Œæˆ"
                }
            }
            post {
                success {
                    // å½’æ¡£æ„å»ºäº§ç‰©
                    archiveArtifacts artifacts: "${JAR_FILE}", fingerprint: true
                    echo "ğŸ“¦ JARåŒ…å·²å½’æ¡£"
                }
                failure {
                    echo "âŒ Mavenæ„å»ºå¤±è´¥"
                }
            }
        }
        
        stage('Dockeræ„å»º') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'develop'
                }
            }
            steps {
                script {
                    echo "ğŸ³ å¼€å§‹æ„å»ºDockeré•œåƒ..."
                    
                    // é‡å‘½åJARæ–‡ä»¶ä»¥åŒ¹é…Dockerfile
                    sh 'cp target/ums-0.0.1-SNAPSHOT.jar ums-0.0.1-SNAPSHOT.jar'
                    
                    // æ„å»ºDockeré•œåƒ
                    docker.build(DOCKER_IMAGE)
                    
                    echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ: ${DOCKER_IMAGE}"
                }
            }
            post {
                failure {
                    echo "âŒ Dockeræ„å»ºå¤±è´¥"
                }
            }
        }
        
        stage('éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
                    
                    // ä½¿ç”¨docker-composeéƒ¨ç½²
                    sh """
                        # åœæ­¢ç°æœ‰æœåŠ¡
                        docker-compose down || true
                        
                        # å¯åŠ¨æ‰€æœ‰æœåŠ¡
                        docker-compose up -d
                        
                        # ç­‰å¾…æœåŠ¡å¯åŠ¨
                        sleep 30
                        
                        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                        docker-compose ps
                    """
                    
                    echo "âœ… æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
                }
            }
            post {
                failure {
                    echo "âŒ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
                    sh 'docker-compose logs ums-app || true'
                }
            }
        }
        
        stage('éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                }
            }
            steps {
                script {
                    echo "ğŸš€ å‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
                    
                    // ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç¡®è®¤
                    timeout(time: 5, unit: 'MINUTES') {
                        input message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ', ok: 'ç¡®è®¤éƒ¨ç½²'
                    }
                    
                    echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
                    
                    // ä½¿ç”¨docker-composeéƒ¨ç½²
                    sh """
                        # åœæ­¢ç°æœ‰æœåŠ¡
                        docker-compose down || true
                        
                        # å¯åŠ¨æ‰€æœ‰æœåŠ¡
                        docker-compose up -d
                        
                        # ç­‰å¾…æœåŠ¡å¯åŠ¨
                        sleep 30
                        
                        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                        docker-compose ps
                    """
                    
                    echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
                }
            }
            post {
                failure {
                    echo "âŒ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
                    sh 'docker-compose logs ums-app || true'
                }
            }
        }
        
        stage('å¥åº·æ£€æŸ¥') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'develop'
                }
            }
            steps {
                script {
                    echo "ğŸ¥ å¼€å§‹å¥åº·æ£€æŸ¥..."
                    
                    // ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨
                    sh 'sleep 60'
                    
                    // æ£€æŸ¥åº”ç”¨çŠ¶æ€
                    sh """
                        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
                        docker ps | grep ums-server || echo "å®¹å™¨æœªè¿è¡Œ"
                        
                        # æ£€æŸ¥åº”ç”¨ç«¯å£
                        curl -f http://localhost:38080/actuator/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"
                        
                        # æ£€æŸ¥åº”ç”¨æ—¥å¿—
                        docker logs ums-server --tail 20 || true
                    """
                    
                    echo "âœ… å¥åº·æ£€æŸ¥å®Œæˆ"
                }
            }
            post {
                failure {
                    echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
                }
            }
        }
    }
    
    post {
        always {
            // æ¸…ç†å·¥ä½œç©ºé—´
            cleanWs()
            echo "ğŸ§¹ å·¥ä½œç©ºé—´å·²æ¸…ç†"
        }
        success {
            echo "ğŸ‰ æµæ°´çº¿æ‰§è¡ŒæˆåŠŸï¼"
            echo "ğŸ“± åº”ç”¨è®¿é—®åœ°å€: http://localhost:38080"
        }
        failure {
            echo "ğŸ’¥ æµæ°´çº¿æ‰§è¡Œå¤±è´¥ï¼"
        }
        unstable {
            echo "âš ï¸ æµæ°´çº¿æ‰§è¡Œä¸ç¨³å®šï¼"
        }
    }
} 